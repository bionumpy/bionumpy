# Main entrypoint of the workflow. 
# Please follow the best practices: 
# https://snakemake.readthedocs.io/en/stable/snakefiles/best_practices.html,
# in particular regarding the standardized folder structure mentioned there. 
import bionumpy as bnp
from bionumpy.intervals import intersect
include: "rules/translate.smk"

rule all:
    input:
        [f"results/{program}/protein_sequences/l150_n1000000.fa"
         for program in ["bionumpy", "biopython", "biostrings"]],
        [f"results/{program}/intersect/100000_1000000.bed"
         for program in ["bionumpy", "bedtools"]],


rule simulate_dna:
    output:
        "results/dna_sequences/l{length}_n{number}.fa"
    run:
        import random
        with open(output[0], "w") as f:
            for i in range(int(wildcards.number)):
                f.write(f">{i}\n")
                f.write("".join(random.choices("ACGT", k=int(wildcards.length)))+ "\n")


rule make_chrom_sizes:
    output:
        "results/chrom.sizes"
    run:
        out = ""
        for chrom in range(1, 11):
            out += f"{chrom}\t1000000\n"
        open(output[0], "w").write(out)


rule simulate_intervals:
    input:
        "results/chrom.sizes"
    output:
        "results/intervals/{n_intervals}.bed"
    run:
        import random
        chrom_sizes = [(str(l.split()[0]), int(l.split()[1])) for l in open(input[0])]
        with open(output[0], "w") as f:
            for chromosome_name, size in chrom_sizes:
                start = 1
                for _ in range(int(wildcards.n_intervals)):
                    end = start+random.randint(1, 100)
                    f.write(f"{chromosome_name}\t{start}\t{end}\t.\t.\t+\n")
                    start = end + random.randint(1, 10)


rule intersect_bionumpy:
    input:
        a="results/intervals/{b}.bed",
        b="results/intervals/{a}.bed",
        chrom_sizes="results/chrom.sizes"
    output:
        "results/bionumpy/intersect/{a}_{b}.bed"
    benchmark:
        "benchmarks/intersect/bionumpy/{a}_{b}.txt"
    run:
        chrom_sizes = bnp.open(input.chrom_sizes).read()
        a = bnp.open(input[0]).read_chunks()
        b = bnp.open(input[1]).read_chunks()
        ms = bnp.streams.MultiStream(chrom_sizes, a=a, b=b)
        result = bnp.intervals.intersect(ms.a, ms.b)
        print(result)


rule intersect_bedtools:
    input:
        "results/intervals/{b}.bed",
        "results/intervals/{a}.bed"
    output:
        "results/bedtools/intersect/{a,\d+}_{b,\d+}.bed"
    benchmark:
        "benchmarks/intersect/bedtools/{a}_{b}.txt"
    shell:
        "bedtools intersect -a {input[0]} -b {input[1]} > {output} -sorted"


rule intersect_check:
    input:
        "results/bedtools/intersect/{a}_{b}.bed",
        "results/bionumpy/intersect/{a}_{b}.bed"
    output:
        "results/intersect/{a\d+}_{b\d+}.check"
    run:
        a = (line.strip().split("\t")[:3] for line in open(input[0]))
        b = (line.strip().split("\t")[:3] for line in open(input[1]))
        for l, l2 in zip(a, b):
            assert l==l2, (l, l2)
        open(output[0], "w").write("1")

